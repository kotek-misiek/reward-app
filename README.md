# Reward - App
## Short description
Reward-app (further 'application') contains two modules: 
1. **Reward** - the application itself
2. **Acceptance-tests** - acceptation tests sending HTTP requests to the running application.

Application saves its data in in-memory database **H2**. All the data saves only in memory and restore the initial database state after a restart of the application. The initial SQL commands are in the file '\Reward\src\main\resources\data.sql'.
## DB structure
There are three tables in a database:
1. **USERS** - list of users with columns **ID**, **FIRST_NAME** and **LAST_NAME**.
   The application hasn't any possibility to edit/add/remove users. They are always three users for all the time.
2. **ACCOUNTS** - list of accounts where the tables **ACCOUNT**/**USERS** have a relation One-To-One (one account belongs to one user and one user has only one account).
   There are two accounts attached to two users. The third user is not attached to any account, it is "up in the air" to check some exceptions.
   Columns: **ID**, **USER_ID**, **AMOUNT** (amount of money on the account) and **UPDATE_TIME** (last update of an account).
3. **TRANSACTIONS** - list of all transaction for all accounts. TRANSACTIONS/ACCOUNTS have a relation Many-To-One (many transactions to one account).
   Columns: **ID**, **ACCOUNT_ID**, **AMOUNT** (amount of a transaction), **T_TYPE** (transaction type: _A_ - added and _U_ - updated), **UPDATE_TIME** (time of the transaction).
## Configuration
Configuration parameters are in the file `application.yaml`
Main groups of parameters:
1. Server
2. Spring configuration (incl.database configuration)
3. Application parameters: `period-month` (3 months) and `thresholds` of _50_ (_1_ point) and _100_ (_2_ points). The configuration is created to add a possibility to add some additional thresholds if needs. The application code gives such of possibility. 
## Web interface
The interface gives possibility to perform all CRUD operations with the transaction and to count a reward for each user. 
In a case of any data error (in a request or in a database) the application returns an error communicate in JSON format (with an appropriate HTTP status), anything like this below.
```
{
   "timestamp": "2023-09-14T00:30:25.2450216",
   "status": 400,
   "error": "Bad Request",
   "message": "User with ID = -100 not found",
   "path": "/transactions/all/-100"
}
```
Such of format of exceptions are provided by the class `RewardExceptionHandler` proceeding all the type of exceptions generated by the application.

The endpoints are defined in two Controller classes: `RewardController` and `TransactionController`.
All endpoints (of both controllers) use _path variables_ as parameters.
1. `RewardController` 
   * `getReward` 
     * **GET** _URL_: `/reward/{userId}` where `{userId}` can be _1_ or _2_ in this application;
       If this `userId` has another value or there has no value (`/reward`) the application return a JSON error message.
2. `TransactionController`
   * `getAllTransactions` 
     * **GET** _URL_: `/transactions/all`: returns all the transactions saved in a database;
     * **GET** _URL_: `/transactions/all/{userId}`: returns all the transactions belonging to a user with this `userId`;
   * `getLastTransactions`
     * **GET** _URL_: `/transactions/{userId}`: returns all the transactions belonging to a user with this `userId` not later than before 3 months (parameter `reward.period-months` in `application.yaml` defines this interval);
   * `addTransaction`
     * **POST** _URL_: `/transactions/{userId}/{amount}`: add a transaction to an account of a user with a given `userId`. The request returns a transaction data in JSON format like below. An incorrect value of `userId` and `amount` params invoke the exception message like above;
   * `updateLastTransaction`
     * **PUT** _URL_: `/transactions/{userId}/{amount}`: update a **last** transaction (i.e with a maximal value of `updateTime`) of an account of a user with a given `userId`. The updated transaction has the field `transactionType` equals _U_ ("updated).  A request returns a transaction data in JSON format like below;
   * `deleteLastTransaction`
     * **DELETE** _URL_: `/transactions/{userId}`: delete a **last** transaction (i.e with a maximal value of `updateTime`) of an account of a user with a given `userId`. The request returns a full list of transactions for this user leaving after this operation (like in `getLastTransactions`); 

_This is a transaction data returning by some endpoints_ (some other return list of similar blocks):
```
         {
             "id": 8,
             "account": {
                 "id": 1,
                 "user": {
                     "id": 1,
                     "firstName": "John",
                     "lastName": "Wick"
                 },
                 "amount": 120.00,
                 "updateTime": "2023-09-13T23:23:52.785+00:00"
             },
             "amount": 100.0,
             "transactionType": "A",
             "updateTime": "2023-09-13T23:23:58.860+00:00"
         }
```
Endpoints `updateLastTransaction` and `deleteLastTransaction` contains more than one operation on the DB so they have maximal transaction isolation level `SERIALIZABLE` to avoid any possible problems in possible multi-user environnment. 
## Application structure
The application code is structured and divided of some functional packages: `controller` (controllers with endpoints), `entity` (DB entities), `enums` (one single enum defining `transactionType`), `exceptions` (self-made exceptions and exception handler), `properties` (structured properties classes), `repository` (JPA repositories) and `service` (interfaces and implementations of the endpoints functionalities).

## Testing
Unit tests are based on `Spock` (`Groovy`). They cover methods in services classes.
Acceptation tests are in the special module `Acceptance-tests`. The profile of an acceptance tests checking id disabled by default in `Maven`.

## Used technologies
* Java 17
* Lombok
* Spring boot
* JPA
* Spock (Groovy)
* In-memory SQL DB H2
* REST assured for acceptance tests

P.S. Maybe it was possible to create more advanced functionality or to optimise some weak points, but I had a strong deficit of time.

That's all from my side.